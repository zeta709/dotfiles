#!/bin/bash

# A light-weight script for sending a message to Slack.
#
# Usage: post-slack [-u username] [-c channel] [--] text
# Send text to channel as username.
#
# This script is bash/zsh compatible.

post-slack() {
	[[ "$#" -lt "1" ]] && return 1
	[[ -z "$SLACK_WEBHOOK_URL" ]] && return 1

	local pos username channel text
	pos=()
	while [[ "$#" -gt "0" ]]; do
		case "$1" in
			-u)
				username="$2"
				shift 2
				;;
			-c)
				channel="$2"
				shift 2
				;;
			--)
				shift
				pos+=("$@")
				break
				;;
			*)
				pos+=("$1")
				shift
				;;
		esac
	done
	: "${username:=$(hostname -s)}"
	text="${pos[*]}"

	local payload="{"
	payload+="\"text\": \"${text//\"/\\\"}\""
	[[ -n "$username" ]] && payload+=", \"username\": \"${username//\"/\\\"}\""
	[[ -n "$channel" ]] && payload+=", \"channel\": \"${channel//\"/\\\"}\""
	payload+="}"

	curl -s -X POST -H 'Content-type: application/json' --data "$payload" \
		"$SLACK_WEBHOOK_URL"
}

post-slack "$@"
